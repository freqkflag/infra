# Compose File Environment Variable Loading

**Created:** 2025-11-22  
**Last Updated:** 2025-11-22  
**Status:** Active Documentation

---

## Overview

This document describes the patterns and best practices for loading environment variables in Docker Compose files across the infrastructure. It addresses the differences between orchestrator-level and service-level compose files, and provides guidance for consistent secret injection.

---

## Environment Variable Loading Patterns

### Pattern 1: Service-Level Compose Files (Recommended)

**Location:** `services/<service>/compose.yml`  
**Pattern:** Uses `env_file` directive to load secrets from `.workspace/.env`

**Example:**
```yaml
version: "3.9"

services:
  postgres:
    image: postgres:16-alpine
    env_file:
      - ../../.workspace/.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
```

**Characteristics:**
- ✅ Uses `env_file: ../../.workspace/.env` directive
- ✅ Automatically loads all variables from `.workspace/.env`
- ✅ Variables available via `${VAR_NAME}` syntax
- ✅ Works reliably with Infisical Agent-generated `.workspace/.env`
- ✅ No shell environment dependencies

**Best Practices:**
1. Always use relative path: `../../.workspace/.env`
2. Reference variables using `${VAR_NAME}` syntax
3. Document required variables in service README
4. Use Infisical for secret storage

---

### Pattern 2: Orchestrator-Level Compose Files

**Location:** `compose.orchestrator.yml`  
**Pattern:** Uses `extends` to reference service compose files, but does NOT use `env_file`

**Example:**
```yaml
version: "3.9"

services:
  postgres:
    extends:
      file: ./services/postgres/compose.yml
      service: postgres
    environment:
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    profiles: ["vps"]
```

**Characteristics:**
- ⚠️ Does NOT use `env_file` directive at orchestrator level
- ⚠️ Requires environment variables in shell or explicit `--env-file` flag
- ⚠️ Variables must be available in shell environment when running `docker compose`
- ✅ Service-level compose files (via `extends`) can still use `env_file`

**Limitations:**
- Orchestrator compose does not automatically load `.workspace/.env`
- Must use `docker compose --env-file .workspace/.env -f compose.orchestrator.yml up`
- Or ensure variables are in shell environment before running compose

**Best Practices:**
1. Use service-level compose files for services requiring secrets
2. If using orchestrator, pass `--env-file` flag explicitly
3. Document environment variable requirements
4. Use helper scripts for orchestrator deployments

---

### Pattern 3: Root-Level Compose Files (Legacy)

**Location:** `<service>/docker-compose.yml` (e.g., `n8n/docker-compose.yml`)  
**Pattern:** Uses `env_file` with relative path to `.workspace/.env`

**Example:**
```yaml
version: "3.9"

services:
  n8n:
    image: n8nio/n8n:latest
    env_file:
      - ../.workspace/.env
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
```

**Characteristics:**
- ✅ Uses `env_file: ../.workspace/.env` (one level up from service directory)
- ✅ Works with Infisical Agent-generated `.workspace/.env`
- ⚠️ Legacy pattern - services should migrate to `services/<service>/compose.yml`

**Migration Path:**
1. Move compose file to `services/<service>/compose.yml`
2. Update `env_file` path to `../../.workspace/.env`
3. Update orchestrator references if needed
4. Test deployment

---

## Environment Variable Sources

### Primary Source: Infisical

**Location:** Infisical `/prod` path  
**Destination:** `.workspace/.env` (generated by Infisical Agent)  
**Update Frequency:** Every 60 seconds (via Infisical Agent)

**Flow:**
1. Secrets stored in Infisical `/prod` environment
2. Infisical Agent (`infisical-agent.yml`) generates `.workspace/.env`
3. Compose files load `.workspace/.env` via `env_file` directive
4. Services receive environment variables at runtime

**Configuration:**
- **Agent Config:** `/root/infra/infisical-agent.yml`
- **Template:** `prod.template` (fetches from `/prod` path)
- **Destination:** `/root/infra/.workspace/.env`
- **Polling Interval:** 60 seconds

### Manual Override: Direct Infisical Injection

**Pattern:** Use `infisical run` to inject secrets directly

**Example:**
```bash
infisical run --env=prod -- docker compose -f services/postgres/compose.yml up -d
```

**Characteristics:**
- ✅ Bypasses `.workspace/.env` file
- ✅ Direct secret injection from Infisical
- ✅ Useful for one-off deployments
- ⚠️ Requires Infisical CLI authentication

---

## Environment Variable Validation

### Pre-Deployment Validation

**Script:** `scripts/validate-env-loading.sh`

**Checks:**
1. Verify `.workspace/.env` exists and is readable
2. Check required variables are present
3. Validate variable formats (no empty values, proper syntax)
4. Test variable injection in dry-run mode
5. Verify service-specific requirements

**Usage:**
```bash
# Validate all services
./scripts/validate-env-loading.sh

# Validate specific service
./scripts/validate-env-loading.sh services/postgres
```

### Runtime Validation

**Health Checks:**
- Services should verify required environment variables at startup
- Health checks should fail if critical variables are missing
- Log warnings for missing optional variables

**Example:**
```yaml
healthcheck:
  test:
    - CMD-SHELL
    - "test -n \"$$POSTGRES_PASSWORD\" && pg_isready -U $$POSTGRES_USER || exit 1"
```

---

## Common Patterns and Examples

### Pattern: Database Service with Secrets

```yaml
services:
  postgres:
    image: postgres:16-alpine
    env_file:
      - ../../.workspace/.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
```

### Pattern: Application Service with Database Connection

```yaml
services:
  wikijs:
    image: requarks/wikijs:latest
    env_file:
      - ../../.workspace/.env
    environment:
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${WIKIJS_DB_USER}
      DB_PASS: ${WIKIJS_DB_PASSWORD}
      DB_NAME: ${WIKIJS_DB_NAME}
    depends_on:
      - postgres
```

### Pattern: Service with Multiple Secret Sources

```yaml
services:
  infisical:
    image: infisical/infisical:latest
    env_file:
      - ../../.workspace/.env
    environment:
      DB_CONNECTION_URI: ${INFISICAL_DB_CONNECTION}
      REDIS_URL: ${INFISICAL_REDIS_URL}
      NEXT_PUBLIC_SITE_URL: ${INFISICAL_PUBLIC_URL}
```

---

## Troubleshooting

### Issue: Variables Not Loading

**Symptoms:**
- Service fails to start
- Error: "variable not set" or "undefined variable"
- Service connects with wrong credentials

**Diagnosis:**
1. Check `.workspace/.env` exists: `ls -la .workspace/.env`
2. Verify variable in file: `grep VAR_NAME .workspace/.env`
3. Check `env_file` path is correct (relative to compose file location)
4. Verify Infisical Agent is running: `ps aux | grep infisical`
5. Check Infisical secret exists: `infisical secrets get --env prod --path /prod VAR_NAME`

**Solutions:**
- Fix `env_file` path (use relative path from compose file)
- Restart Infisical Agent: `infisical agent --config infisical-agent.yml`
- Manually sync secrets: `infisical export --env prod --path /prod --format env > .workspace/.env`
- Use direct injection: `infisical run --env=prod -- docker compose up`

### Issue: Orchestrator Compose Not Loading Variables

**Symptoms:**
- Orchestrator services fail to start
- Variables undefined when using `compose.orchestrator.yml`

**Solutions:**
1. Use explicit `--env-file` flag:
   ```bash
   docker compose --env-file .workspace/.env -f compose.orchestrator.yml up -d
   ```
2. Source variables in shell:
   ```bash
   set -a; source .workspace/.env; set +a
   docker compose -f compose.orchestrator.yml up -d
   ```
3. Use service-level compose files instead:
   ```bash
   docker compose -f services/postgres/compose.yml up -d
   ```

### Issue: Variable Path Mismatch

**Symptoms:**
- `env_file` path not found
- Error: "no such file or directory"

**Solutions:**
- Verify relative path from compose file location
- Service-level: `../../.workspace/.env` (two levels up)
- Root-level: `../.workspace/.env` (one level up)
- Use absolute path if needed: `/root/infra/.workspace/.env`

---

## Best Practices Summary

### ✅ DO

1. **Use service-level compose files** for services requiring secrets
2. **Always use `env_file: ../../.workspace/.env`** in service compose files
3. **Reference variables using `${VAR_NAME}` syntax**
4. **Document required variables** in service README files
5. **Validate environment variables** before deployment
6. **Use Infisical** for all secret storage
7. **Test variable injection** in health checks

### ❌ DON'T

1. **Don't hardcode secrets** in compose files
2. **Don't rely on shell environment** for orchestrator deployments
3. **Don't use absolute paths** for `env_file` (use relative paths)
4. **Don't commit `.workspace/.env`** to version control
5. **Don't use template passwords** in production
6. **Don't skip validation** before deployment

---

## Deployment Procedures

### Standard Deployment (Service-Level)

```bash
cd /root/infra
# Ensure Infisical Agent is running and .workspace/.env is current
docker compose -f services/<service>/compose.yml up -d
```

### Orchestrator Deployment

```bash
cd /root/infra
# Option 1: Use explicit --env-file flag
docker compose --env-file .workspace/.env -f compose.orchestrator.yml up -d

# Option 2: Source variables in shell
set -a; source .workspace/.env; set +a
docker compose -f compose.orchestrator.yml up -d
```

### Direct Infisical Injection

```bash
cd /root/infra
# Bypass .workspace/.env, inject directly from Infisical
infisical run --env=prod -- docker compose -f services/<service>/compose.yml up -d
```

---

## Preflight Checks

### Environment Variable Preflight

Add to `scripts/preflight.sh`:

```bash
# Check .workspace/.env exists
if [ ! -f .workspace/.env ]; then
  echo "ERROR: .workspace/.env not found. Run Infisical Agent or sync secrets."
  exit 1
fi

# Check required variables
REQUIRED_VARS=("POSTGRES_PASSWORD" "MARIADB_ROOT_PASSWORD" "REDIS_PASSWORD")
for var in "${REQUIRED_VARS[@]}"; do
  if ! grep -q "^${var}=" .workspace/.env; then
    echo "WARNING: ${var} not found in .workspace/.env"
  fi
done
```

---

## References

- **Main Documentation:** `AGENTS.md` - Service overview and environment variable usage
- **Remediation Plan:** `REMEDIATION_PLAN.md` - Phase 1.6 environment variable loading standardization
- **Infisical Integration:** `infisical/README.md` - Infisical Agent configuration
- **Service Documentation:** Individual service README files

---

**Last Updated:** 2025-11-22  
**Maintained By:** DevOps Team / Infrastructure Lead

