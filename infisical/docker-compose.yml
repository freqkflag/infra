services:
  redis:
    image: redis:7-alpine
    container_name: infisical-redis
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
    networks:
      - infisical-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  infisical-db:
    image: postgres:15-alpine
    container_name: infisical-db
    env_file:
      - ../.workspace/.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-infisical}
      POSTGRES_USER: ${POSTGRES_USER:-infisical}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - infisical-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-infisical}"]
      interval: 10s
      timeout: 5s
      retries: 5

  infisical:
    image: infisical/infisical:v0.154.0
    container_name: infisical
    depends_on:
      infisical-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ../.workspace/.env
    environment:
      # Database
      DB_CONNECTION_URI: postgresql://${POSTGRES_USER:-infisical}:haL3CUddcVt6d3NZR29GqViGo58Q2ZcQV%2F88CmNxcDU%3D@infisical-db:5432/${POSTGRES_DB:-infisical}
      
      # Redis
      REDIS_URL: redis://redis:6379
      
      # Encryption
      ROOT_ENCRYPTION_KEY: ${ROOT_ENCRYPTION_KEY}
      
      # JWT
      JWT_SIGNUP_SECRET: ${JWT_SIGNUP_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_AUTH_SECRET: ${JWT_AUTH_SECRET}
      JWT_SERVICE_SECRET: ${JWT_SERVICE_SECRET}
      JWT_PROVIDER_AUTH_SECRET: ${JWT_PROVIDER_AUTH_SECRET}
      
      # App
      SITE_URL: https://infisical.freqkflag.co
      SERVER_URL: https://infisical.freqkflag.co
      
      # SMTP (optional - can use Mailu)
      SMTP_FROM_ADDRESS: ${SMTP_FROM_ADDRESS:-noreply@freqkflag.co}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Infisical}
      SMTP_HOST: ${SMTP_HOST:-mail.freqkflag.co}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-true}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      
      # Features
      ENABLE_SIGNUP: ${ENABLE_SIGNUP:-true}
      TRUST_PROXY: "true"
      
      # GitHub OAuth/SSO (optional)
      GITHUB_CLIENT_ID: ${INFISICAL_GITHUB_CLIENT_ID:-${GITHUB_CLIENT_ID:-}}
      GITHUB_CLIENT_SECRET: ${INFISICAL_GITHUB_CLIENT_SECRET:-${GITHUB_CLIENT_SECRET:-}}
      GITHUB_OAUTH_ENABLED: ${GITHUB_OAUTH_ENABLED:-false}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - ./data/infisical:/app/data
    networks:
      - infisical-network
      - traefik-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.infisical.rule=Host(`infisical.freqkflag.co`)"
      - "traefik.http.routers.infisical.entrypoints=websecure"
      - "traefik.http.routers.infisical.tls.certresolver=letsencrypt"
      - "traefik.http.routers.infisical.middlewares=security-headers@file"
      - "traefik.http.services.infisical.loadbalancer.server.port=8080"

networks:
  infisical-network:
    driver: bridge
  traefik-network:
    external: true
    name: traefik-network