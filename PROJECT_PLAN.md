<!-- Project Plan generated by Orchestrator Agent -->
# Cult of Joey Infrastructure Build Plan

## 1. Overview

- **Repository:** `freqkflag/infra`
- **Primary objective:** deliver a reproducible, multi-host stack spanning `vps.host`, `home.macmini`, and `home.linux`.
- **Tooling:** Docker Compose, Traefik, Cloudflared, Infisical, Kong OSS, ClamAV, n8n/Node-RED (all FOSS).
- **Authoritative references:** `infra-build-plan.md`, `AGENTS.md`, `project-plan.yml`, this document.

## 2. Prerequisites

| Requirement | Validation Command |
| ----------- | ------------------ |
| Docker daemon + Compose v2 | `docker --version && docker compose version` |
| Infisical CLI | `infisical --version` |
| Workspace env file | `test -f .workspace/.env` |
| Repo sync | `git status --short` (clean or intentional branch) |
| Edge network | `docker network inspect edge >/dev/null 2>&1 || docker network create --driver bridge edge` |

> All commands should run via `infisical run --env=<environment>` whenever secrets are required.

## 3. Node Inventory

| Host | Profile | Node Directory | Compose Bundle | Deploy Script | Domains Config | Networks Config | Cloudflared Token |
| ---- | ------- | -------------- | -------------- | ------------- | -------------- | --------------- | ----------------- |
| `vps.host` | production | `nodes/vps.host/` | `nodes/vps.host/compose.yml` | `nodes/vps.host/deploy.sh` | `nodes/vps.host/domains.yml` | `nodes/vps.host/networks.yml` | `${CF_TUNNEL_TOKEN_VPS}` |
| `home.macmini` | development | `nodes/home.macmini/` | `nodes/home.macmini/compose.yml` | `nodes/home.macmini/deploy.sh` | `nodes/home.macmini/domains.yml` | `nodes/home.macmini/networks.yml` | `${CF_TUNNEL_TOKEN_MAC}` |
| `home.linux` | homelab | `nodes/home.linux/` | `nodes/home.linux/compose.yml` | `nodes/home.linux/deploy.sh` | `nodes/home.linux/domains.yml` | `nodes/home.linux/networks.yml` | `${CF_TUNNEL_TOKEN_LINUX}` |

Domain coverage:
- `nodes/vps.host/domains.yml` — freqkflag.co services (Traefik, Kong, Infisical, application suite).
- `nodes/home.macmini/domains.yml` — twist3dkink.online developer endpoints (frontend, dev-tools).
- `nodes/home.linux/domains.yml` — cult-of-joey.com homelab endpoints (Vaultwarden, BookStack, Auxiliary).

Networks & tunnels:
- Each node attaches to the shared external `edge` network as described in its `networks.yml`.
- Cloudflared tunnel metadata (token variables and purpose) resides alongside each node; execute node scripts with `infisical run --env=<profile>` to populate secrets.

## 4. Service Inventory & Dependencies

| Layer | Services | Depends On |
| ----- | -------- | ---------- |
| Foundations | Infisical DB (Postgres + Redis) | Docker, volumes |
| Secrets | Infisical API/UI | Postgres, Redis |
| Ingress | Traefik | Cloudflare DNS API, edge network |
| Tunnels | Cloudflared | Traefik, CF tokens |
| API Gateway | Kong OSS | Traefik, Infisical, Postgres |
| Data Stores | Postgres, MariaDB, Redis | Traefik (for admin UIs), Infisical |
| Security | ClamAV | Data stores |
| Apps | Ghost, WordPress, Discourse, Wiki.js, Gitea, Linkstack, LocalAI, OpenWebUI, Node-RED, Vaultwarden, BookStack, Auxiliary, Frontend, Dev-tools | Gateways + databases |
| Automation | n8n / Node-RED flows | Apps + logging layer |

## 5. Execution Order

1. **Discovery Phase**
   - Run `./scripts/preflight.sh`.
   - Inventory services & env variables; update `PROJECT_PLAN.md` if needed.
2. **Compose Phase**
   - Generate/update per-service `services/<name>/compose.yml`.
   - Update orchestrator bundle `compose.orchestrator.yml` with host profiles.
   - Keep node bundles current under `nodes/<host>/compose.yml`.
3. **Secrets Phase**
   - Ensure `.env` templates + Infisical entries cover every `${VAR}`.
   - Run `infisical run --env=production -- infisical export --format yaml --path prod/` for audit.
4. **Deployment Phase**
   - For each host: `infisical run --env=<env> -- ./nodes/<host>/deploy.sh` (wrapper around `scripts/deploy.ah`).
   - Validate globally with `./scripts/status.sh` and per-node with `./nodes/<host>/health-check.sh`.
5. **Verification Phase**
   - `docker logs --tail 50 cloudflared`
   - `docker exec traefik traefik healthcheck`
   - `curl -s https://api.freqkflag.co/status --header "Authorization: Kong-Key ${KONG_ADMIN_KEY}"`
6. **Documentation & Review**
   - Update `CHANGE.log`, `server-changelog.md`.
   - Review agent signs off, release agent commits/pushes (`git commit -S`).

## 6. Environment Templates

- `env/templates/base.env.example` — shared defaults (timezone, CF tokens, Traefik vars).
- `env/templates/vps.env.example` — production overrides (DB creds, public domains).
- `env/templates/mac.env.example` — development overrides (frontend tooling).
- `env/templates/linux.env.example` — homelab overrides (Vaultwarden, BookStack).
- `.env.example` at repo root lists the minimum keys new operators must populate before running bootstrap scripts.
- Node-specific domain and network manifests are maintained under `nodes/<host>/domains.yml` and `nodes/<host>/networks.yml`.

## 7. Branch & Review Policy

- Each phase lands in a dedicated branch named `feat/<phase>-<short-desc>`.
- Commits must mention assumptions inline, e.g. `feat(compose): add mac profile (# assumes dev DNS stays on twist3dkink.online)`.
- Review agent validates diffs + tests before Release agent merges or submits PR.

## 8. Incident & Recovery Checklist

1. Document issue in `server-changelog.md` with severity level.
2. Run `./scripts/status.sh` + `./nodes/<host>/health-check.sh`.
3. If rollback needed, execute `./scripts/teardown.sh` with affected services.
4. After remediation, trigger `infisical run --env=production -- n8n execute --workflow post-recovery-audit`.
5. Commit any config or doc updates; ensure CF tunnels + DNS are synced.

---

Maintaining this plan alongside `infra-build-plan.md` ensures every agent shares the same sequence, prerequisites, and expectations before touching the infrastructure.
