<!-- Project Plan generated by Orchestrator Agent -->
# Cult of Joey Infrastructure Build Plan

## 1. Overview

- **Repository:** `freqkflag/infra`
- **Primary objective:** deliver a reproducible, multi-host stack spanning `vps.host`, `home.macmini`, and `home.linux`.
- **Tooling:** Docker Compose, Traefik, Cloudflared, Infisical, Kong OSS, ClamAV, n8n/Node-RED (all FOSS).
- **Authoritative references:** `infra-build-plan.md`, `AGENTS.md`, `project-plan.yml`, this document.

## 2. Prerequisites

| Requirement | Validation Command |
| ----------- | ------------------ |
| Docker daemon + Compose v2 | `docker --version && docker compose version` |
| Infisical CLI | `infisical --version` |
| Workspace env file | `test -f .workspace/.env` |
| Repo sync | `git status --short` (clean or intentional branch) |
| Edge network | `docker network inspect edge >/dev/null 2>&1 || docker network create --driver bridge edge` |

> All commands should run via `infisical run --env=<environment>` whenever secrets are required.

## 3. Environment Matrix

| Host | Domain(s) | Profile | Cloudflared Token |
| ---- | --------- | ------- | ----------------- |
| `vps.host` | `freqkflag.co`, `cultofjoey.com`, shared ingress | `production` | `${CF_TUNNEL_TOKEN_VPS}` |
| `home.macmini` | `twist3dkink.online`, dev subdomains | `development` | `${CF_TUNNEL_TOKEN_MAC}` |
| `home.linux` | `cult-of-joey.com`, `notes.cult-of-joey.com` | `homelab` | `${CF_TUNNEL_TOKEN_LINUX}` |

All services attach to the external `edge` network and load environment variables from the shared `.env` templates (see §6).

## 4. Service Inventory & Dependencies

| Layer | Services | Depends On |
| ----- | -------- | ---------- |
| Foundations | Infisical DB (Postgres + Redis) | Docker, volumes |
| Secrets | Infisical API/UI | Postgres, Redis |
| Ingress | Traefik | Cloudflare DNS API, edge network |
| Tunnels | Cloudflared | Traefik, CF tokens |
| API Gateway | Kong OSS | Traefik, Infisical, Postgres |
| Data Stores | Postgres, MariaDB, Redis | Traefik (for admin UIs), Infisical |
| Security | ClamAV | Data stores |
| Apps | Ghost, WordPress, Discourse, Wiki.js, Gitea, Linkstack, LocalAI, OpenWebUI, Node-RED, Vaultwarden, BookStack, Auxiliary, Frontend, Dev-tools | Gateways + databases |
| Automation | n8n / Node-RED flows | Apps + logging layer |

## 5. Execution Order

1. **Discovery Phase**
   - Run `./scripts/preflight.sh`.
   - Inventory services & env variables; update `PROJECT_PLAN.md` if needed.
2. **Compose Phase**
   - Generate/update per-service `services/<name>/compose.yml`.
   - Update orchestrator bundle `compose.orchestrator.yml` with host profiles.
3. **Secrets Phase**
   - Ensure `.env` templates + Infisical entries cover every `${VAR}`.
   - Run `infisical run --env=production -- infisical export --format yaml --path prod/` for audit.
4. **Deployment Phase**
   - For each host: `infisical run --env=<env> -- ./scripts/deploy.ah <target>`.
   - Validate with `./scripts/status.sh` and `./scripts/health-check.sh`.
5. **Verification Phase**
   - `docker logs --tail 50 cloudflared`
   - `docker exec traefik traefik healthcheck`
   - `curl -s https://api.freqkflag.co/status --header "Authorization: Kong-Key ${KONG_ADMIN_KEY}"`
6. **Documentation & Review**
   - Update `CHANGE.log`, `server-changelog.md`.
   - Review agent signs off, release agent commits/pushes (`git commit -S`).

## 6. Environment Templates

- `env/templates/base.env.example` — shared defaults (timezone, CF tokens, Traefik vars).
- `env/templates/vps.env.example` — production overrides (DB creds, public domains).
- `env/templates/mac.env.example` — development overrides (frontend tooling).
- `env/templates/linux.env.example` — homelab overrides (Vaultwarden, BookStack).
- `.env.example` at repo root lists the minimum keys new operators must populate before running bootstrap scripts.

## 7. Branch & Review Policy

- Each phase lands in a dedicated branch named `feat/<phase>-<short-desc>`.
- Commits must mention assumptions inline, e.g. `feat(compose): add mac profile (# assumes dev DNS stays on twist3dkink.online)`.
- Review agent validates diffs + tests before Release agent merges or submits PR.

## 8. Incident & Recovery Checklist

1. Document issue in `server-changelog.md` with severity level.
2. Run `./scripts/status.sh` + `./scripts/health-check.sh`.
3. If rollback needed, execute `./scripts/teardown.sh` with affected services.
4. After remediation, trigger `infisical run --env=production -- n8n execute --workflow post-recovery-audit`.
5. Commit any config or doc updates; ensure CF tunnels + DNS are synced.

---

Maintaining this plan alongside `infra-build-plan.md` ensures every agent shares the same sequence, prerequisites, and expectations before touching the infrastructure.
