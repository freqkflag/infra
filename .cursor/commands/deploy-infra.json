{
    "name": "deploy-infra",
    "description": "Deploy a service for the detected host. Usage: deploy-infra service=<service-name>",
    "usage": "deploy-infra service=n8n",
    "command": "bash -lc '\nset -euo pipefail\nSERVICE=\"${service:-}${SERVICE:-}\"\nif [ -z \"$SERVICE\" ]; then echo \"ERROR: you must provide service=<name>\"; exit 2; fi\n# device detection (curl with timeout)\nVPS_IP=\"62.72.26.113\"\nPUBLIC_IP=\"$(curl --max-time 5 -s ifconfig.me || echo \"\")\"\nHOSTNAME=\"$(hostname)\"\n# try to get a local IP (python fallback for portability)\nLOCAL_IP=\"$(python -c \"import socket,sys\ntry:\n s=socket.socket(); s.connect(('8.8.8.8',80)); print(s.getsockname()[0]); s.close()\nexcept Exception:\n print('')\n\")\"\n\nif [ \"$PUBLIC_IP\" = \"$VPS_IP\" ]; then\n  MODE=\"vps\"\n  HOST_FOLDER=\"vps-server\"\nelif [ \"$HOSTNAME\" = \"homelab.local\" ]; then\n  MODE=\"homelab\"\n  HOST_FOLDER=\"homelab-server\"\nelif echo \"$LOCAL_IP\" | grep -q \"^192\\.168\\.12\\.\"; then\n  MODE=\"maclab\"\n  HOST_FOLDER=\"maclab-server\"\nelse\n  MODE=\"maclab\"\n  HOST_FOLDER=\"maclab-server\"\nfi\n\n# banner\necho \"[$(date)][$HOSTNAME][$MODE detected] deploying service=$SERVICE...\"\n\n# cd to repo root\nREPO_ROOT=\"$(git rev-parse --show-toplevel 2>/dev/null || pwd)\"\ncd \"$REPO_ROOT\"\n\nCOMPOSE_PATH=\"./infra/${HOST_FOLDER}/${SERVICE}/docker-compose.yml\"\nif [ ! -f \"$COMPOSE_PATH\" ]; then echo \"ERROR: compose file not found: $COMPOSE_PATH\"; exit 3; fi\n\n# run docker compose (modern CLI)\nset +e\ndocker compose -f \"$COMPOSE_PATH\" up -d --build\nRC=$?\nset -e\n\n# timestamp (ISO local with offset) using python for portability\nTIMESTAMP=\"$(python -c 'from datetime import datetime; print(datetime.now().astimezone().isoformat())')\"\nprintf \"%s %s service=%s rc=%s host=%s\\n\" \"$TIMESTAMP\" \"$MODE\" \"$SERVICE\" \"$RC\" \"$HOSTNAME\" >> ./.cursor/ops-log.txt\n\nif [ \"$RC\" -ne 0 ]; then echo \"deploy finished with rc=$RC\"; exit $RC; fi\n\necho \"deploy finished OK\"\n'"
  }
  