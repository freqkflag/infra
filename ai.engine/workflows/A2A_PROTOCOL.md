# Agent-to-Agent (A2A) Protocol

**Version:** 1.0.0  
**Created:** 2025-11-22  
**Location:** `/root/infra/ai.engine/workflows/`  
**Purpose:** Standardized protocol for agent-to-agent communication, context exchange, authentication, and escalation

## Overview

The A2A Protocol enables autonomous agents to communicate, share context, authenticate, and escalate tasks across the infrastructure. This protocol supports both virtual agents (ai.engine) and registered agents (.cursor/agents), as well as MCP server integration.

## Architecture

```
┌─────────────────┐
│  Orchestrator   │
│     Agent       │
└────────┬────────┘
         │
         ├───► Virtual Agents (ai.engine)
         │     ├── status-agent
         │     ├── bug-hunter
         │     ├── security-agent
         │     └── ...
         │
         ├───► Registered Agents (.cursor/agents)
         │     ├── logger-agent
         │     ├── lint-resolver-agent
         │     ├── preflight-agent
         │     └── ...
         │
         └───► MCP Servers
               ├── Infisical MCP
               ├── Cloudflare MCP
               ├── WikiJS MCP
               └── ...
```

## Protocol Components

### 1. Session Management

#### Session Token Format

```json
{
  "session_id": "a2a-{timestamp}-{random}",
  "orchestrator": "orchestrator-agent",
  "created_at": "2025-11-22T12:00:00Z",
  "expires_at": "2025-11-22T13:00:00Z",
  "task_id": "task-{uuid}",
  "task_metadata": {
    "type": "multi-agent-run",
    "priority": "normal",
    "timeout": 3600
  }
}
```

#### Session Storage

- **Location:** `/root/infra/.workspace/a2a-sessions/`
- **Format:** JSON files named `{session_id}.json`
- **Retention:** 24 hours (auto-cleanup)

### 2. Handshake Protocol

#### Phase 1: Initiation

**Initiator → Target Agent:**

```json
{
  "protocol_version": "1.0.0",
  "message_type": "handshake_init",
  "session_id": "a2a-{timestamp}-{random}",
  "initiator": {
    "agent_id": "orchestrator-agent",
    "agent_type": "virtual",
    "capabilities": ["coordination", "task_delegation"]
  },
  "target": {
    "agent_id": "status-agent",
    "agent_type": "virtual"
  },
  "task": {
    "task_id": "task-{uuid}",
    "description": "Get infrastructure status",
    "priority": "normal",
    "timeout": 300
  },
  "context": {
    "previous_agents": [],
    "shared_data": {}
  },
  "timestamp": "2025-11-22T12:00:00Z"
}
```

#### Phase 2: Acknowledgment

**Target Agent → Initiator:**

```json
{
  "protocol_version": "1.0.0",
  "message_type": "handshake_ack",
  "session_id": "a2a-{timestamp}-{random}",
  "target": {
    "agent_id": "status-agent",
    "agent_type": "virtual",
    "status": "ready",
    "capabilities": ["status_check", "health_monitoring"]
  },
  "accepted": true,
  "estimated_duration": 60,
  "timestamp": "2025-11-22T12:00:01Z"
}
```

#### Phase 3: Context Exchange

**Initiator → Target Agent:**

```json
{
  "protocol_version": "1.0.0",
  "message_type": "context_exchange",
  "session_id": "a2a-{timestamp}-{random}",
  "context": {
    "previous_results": [
      {
        "agent_id": "discovery-cartographer",
        "output": "/tmp/discovery-results.json",
        "timestamp": "2025-11-22T11:55:00Z"
      }
    ],
    "shared_data": {
      "infra_path": "/root/infra",
      "target_services": ["traefik", "infisical", "wikijs"]
    },
    "constraints": {
      "max_execution_time": 300,
      "required_output_format": "json"
    }
  },
  "timestamp": "2025-11-22T12:00:02Z"
}
```

### 3. Authentication

#### Agent Identity

Each agent must provide:

```json
{
  "agent_id": "status-agent",
  "agent_type": "virtual|registered",
  "signature": "sha256-hash-of-agent-id+session-id+secret",
  "capabilities": ["status_check", "health_monitoring"],
  "allowed_hosts": ["vps", "mac"],
  "version": "1.0.0"
}
```

#### Authentication Methods

1. **Session Token Authentication:**
   - Session tokens are generated by the orchestrator
   - Tokens include HMAC signature using shared secret
   - Tokens expire after 1 hour

2. **Agent Signature:**
   - Each agent signs its identity using a shared secret
   - Signature: `HMAC-SHA256(agent_id + session_id + timestamp, secret)`

3. **MCP Server Authentication:**
   - MCP servers use their existing authentication (API keys, tokens)
   - Agents access MCP tools through function calling

### 4. Context Exchange

#### Context Format

```json
{
  "session_id": "a2a-{timestamp}-{random}",
  "context": {
    "previous_agents": [
      {
        "agent_id": "discovery-cartographer",
        "execution_time": "2025-11-22T11:55:00Z",
        "output_file": "/tmp/discovery-results.json",
        "status": "completed",
        "findings": {
          "services_found": 15,
          "issues_detected": 2
        }
      }
    ],
    "shared_data": {
      "infra_path": "/root/infra",
      "target_services": ["traefik", "infisical"],
      "environment": "production"
    },
    "constraints": {
      "max_execution_time": 300,
      "required_output_format": "json",
      "output_location": "/tmp/status-results.json"
    },
    "metadata": {
      "task_id": "task-{uuid}",
      "priority": "normal",
      "timeout": 3600
    }
  }
}
```

#### Context Propagation

- Context is passed via session files in `/root/infra/.workspace/a2a-sessions/`
- Each agent reads previous context and appends its results
- Context is versioned and timestamped

### 5. Escalation Protocol

#### Escalation Levels

1. **Level 1: Agent Retry**
   - Agent retries with exponential backoff
   - Max 3 retries

2. **Level 2: Alternative Agent**
   - Orchestrator delegates to alternative agent
   - Example: `status-agent` fails → try `ops-agent`

3. **Level 3: Human Escalation**
   - Task is logged to `CHANGE.log`
   - Notification sent via n8n webhook
   - Human intervention required

#### Escalation Message Format

```json
{
  "protocol_version": "1.0.0",
  "message_type": "escalation",
  "session_id": "a2a-{timestamp}-{random}",
  "escalation_level": 2,
  "reason": "agent_failure|timeout|error",
  "original_agent": "status-agent",
  "error": {
    "code": "AGENT_TIMEOUT",
    "message": "Agent execution exceeded timeout",
    "details": {}
  },
  "alternative_agent": "ops-agent",
  "timestamp": "2025-11-22T12:05:00Z"
}
```

### 6. Task Metadata

#### Task Definition

```json
{
  "task_id": "task-{uuid}",
  "task_type": "multi-agent-run|single-agent|orchestration",
  "description": "Get infrastructure status and validate health",
  "priority": "low|normal|high|critical",
  "timeout": 3600,
  "agents": [
    {
      "agent_id": "discovery-cartographer",
      "sequence": 1,
      "dependencies": [],
      "timeout": 300
    },
    {
      "agent_id": "compose-engineer",
      "sequence": 2,
      "dependencies": ["discovery-cartographer"],
      "timeout": 600
    },
    {
      "agent_id": "secrets-steward",
      "sequence": 3,
      "dependencies": ["compose-engineer"],
      "timeout": 300
    },
    {
      "agent_id": "review-agent",
      "sequence": 4,
      "dependencies": ["secrets-steward"],
      "timeout": 300
    }
  ],
  "output_location": "/tmp/multi-agent-run-{timestamp}.json",
  "created_at": "2025-11-22T12:00:00Z"
}
```

## Implementation

### Session Management Script

**Location:** `/root/infra/ai.engine/scripts/a2a-session.sh`

```bash
#!/bin/bash
# A2A Session Management
# Usage: a2a-session.sh create|get|update|delete <session_id>

# Creates session, returns session_id
# Gets session data
# Updates session with agent results
# Deletes expired sessions
```

### Enhanced invoke-agent.sh

**Location:** `/root/infra/ai.engine/scripts/invoke-agent.sh`

Enhanced with:
- Session token generation
- Context passing
- A2A handshake
- Result aggregation
- Escalation handling

### Multi-Agent Orchestration

**Location:** `/root/infra/ai.engine/scripts/orchestrate-agents.sh`

Orchestrates multiple agents in sequence:
1. Discovery Cartographer
2. Compose Engineer
3. Secrets Steward
4. Review Agent

## Usage Examples

### Single Agent with Context

```bash
# Create session
SESSION_ID=$(a2a-session.sh create)

# Invoke agent with context
./invoke-agent.sh status-agent /tmp/status.json \
  --session "$SESSION_ID" \
  --context /tmp/discovery-results.json
```

### Multi-Agent Run

```bash
# Orchestrate multiple agents
./orchestrate-agents.sh \
  --agents discovery-cartographer,compose-engineer,secrets-steward,review-agent \
  --output /tmp/multi-agent-run.json \
  --session-timeout 3600
```

### Agent-to-MCP Communication

```bash
# Agent uses MCP tools through function calling
# Example: Security agent uses Infisical MCP to audit secrets
./invoke-agent.sh security-agent /tmp/security.json \
  --mcp-tools infisical,cloudflare \
  --session "$SESSION_ID"
```

## Validation

### Validation Script

**Location:** `/root/infra/ai.engine/scripts/validate-a2a.sh`

Validates:
- Session creation and management
- Handshake protocol
- Context exchange
- Authentication
- Escalation flow

### Test Multi-Agent Run

```bash
# Simulate multi-agent run
./validate-a2a.sh \
  --simulate-discovery \
  --simulate-compose \
  --simulate-secrets \
  --simulate-review \
  --output /tmp/validation-results.json
```

## Security Considerations

1. **Session Tokens:**
   - Tokens expire after 1 hour
   - Tokens are signed with HMAC-SHA256
   - Tokens stored in secure location (`/root/infra/.workspace/a2a-sessions/`)

2. **Agent Authentication:**
   - Each agent must provide valid signature
   - Agent capabilities are verified
   - Host restrictions are enforced

3. **Context Security:**
   - Context files contain no secrets
   - Secrets accessed via Infisical MCP
   - Context files are cleaned up after 24 hours

4. **Escalation Security:**
   - Escalation events are logged
   - Human escalation requires authentication
   - All escalation events are audited

## Monitoring and Logging

### Log Locations

- **Session Logs:** `/root/infra/.workspace/a2a-sessions/*.log`
- **Agent Logs:** `/root/infra/.workspace/a2a-sessions/{session_id}-{agent_id}.log`
- **Escalation Logs:** `/root/infra/CHANGE.log`

### Log Format

```json
{
  "timestamp": "2025-11-22T12:00:00Z",
  "session_id": "a2a-{timestamp}-{random}",
  "agent_id": "status-agent",
  "event_type": "handshake_init|handshake_ack|context_exchange|execution_start|execution_complete|escalation",
  "data": {}
}
```

## Related Documentation

- [AI Engine README](../README.md)
- [MCP Integration](../MCP_INTEGRATION.md)
- [Orchestrator Agent](../agents/orchestrator-agent.md)
- [Agent Registry](../../.cursor/agents/registry.json)

---

**Last Updated:** 2025-11-22  
**Maintained By:** Orchestrator Agent

