
services:
  mastodon-db:
    image: postgres:14
    container_name: mastodon-db
    environment:
      - POSTGRES_USER=mastodon
      - POSTGRES_PASSWORD=mastodon_secure_password
      - POSTGRES_DB=mastodon
    volumes:
      - mastodon_db:/var/lib/postgresql/data
    networks:
      - mastodon-network
    restart: unless-stopped

  mastodon-web:
    image: lscr.io/linuxserver/mastodon:latest
    container_name: mastodon-web
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - LOCAL_DOMAIN=twist3dkinkst3r.com
      - WEB_DOMAIN=twist3dkinkst3r.com
      - REDIS_HOST=mastodon-redis
      - REDIS_PORT=6379
      - DB_HOST=mastodon-db
      - DB_USER=mastodon
      - DB_NAME=mastodon
      - DB_PASS=mastodon_secure_password
      - DB_PORT=5432
      - ES_ENABLED=false
      - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY:-}
      - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY:-}
      - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT:-}
      - SECRET_KEY_BASE=${MASTODON_SECRET_KEY_BASE:-}
      - OTP_SECRET=${MASTODON_OTP_SECRET:-}
      - VAPID_PRIVATE_KEY=${MASTODON_VAPID_PRIVATE_KEY:-}
      - VAPID_PUBLIC_KEY=${MASTODON_VAPID_PUBLIC_KEY:-}
      - SMTP_SERVER=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_LOGIN=${SMTP_LOGIN:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM_ADDRESS=noreply@twist3dkinkst3r.com
      - SMTP_TLS=true
      - S3_ENABLED=true
      - S3_BUCKET=twist3dkinkst3r-mastodon
      - AWS_ACCESS_KEY_ID=${CF_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${CF_SECRET_ACCESS_KEY}
      - S3_ENDPOINT=${CF_R2_BASE_URL}
      - S3_REGION=auto
      - S3_ALIAS_HOST=files.twist3dkinkst3r.com
      - SIDEKIQ_ONLY=false
      - SIDEKIQ_THREADS=5
      - DB_POOL=5
      - NO_CHOWN=
      - MASTODON_PROMETHEUS_EXPORTER_ENABLED=false
    volumes:
      - mastodon_config:/config
    networks:
      - mastodon-network
      - dokploy-network
    ports:
      - "8081:8081"
    depends_on:
      - mastodon-db
      - mastodon-redis
    restart: unless-stopped

  mastodon-sidekiq:
    image: lscr.io/linuxserver/mastodon:latest
    container_name: mastodon-sidekiq
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - LOCAL_DOMAIN=twist3dkinkst3r.com
      - REDIS_HOST=mastodon-redis
      - REDIS_PORT=6379
      - DB_HOST=mastodon-db
      - DB_USER=mastodon
      - DB_NAME=mastodon
      - DB_PASS=mastodon_secure_password
      - DB_PORT=5432
      - ES_ENABLED=false
      - ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY:-}
      - ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY:-}
      - ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT:-}
      - SECRET_KEY_BASE=${MASTODON_SECRET_KEY_BASE:-}
      - OTP_SECRET=${MASTODON_OTP_SECRET:-}
      - VAPID_PRIVATE_KEY=${MASTODON_VAPID_PRIVATE_KEY:-}
      - VAPID_PUBLIC_KEY=${MASTODON_VAPID_PUBLIC_KEY:-}
      - SIDEKIQ_ONLY=true
      - SIDEKIQ_THREADS=5
      - DB_POOL=5
    volumes:
      - mastodon_config:/config
    networks:
      - mastodon-network
      - dokploy-network
    depends_on:
      - mastodon-db
      - mastodon-redis
    restart: unless-stopped

  mastodon-redis:
    image: redis:7-alpine
    container_name: mastodon-redis
    command: redis-server --appendonly yes
    volumes:
      - mastodon_redis:/data
    networks:
      - mastodon-network
    restart: unless-stopped

volumes:
  mastodon_config:
    driver: local
  mastodon_redis:
    driver: local
  mastodon_db:
    driver: local

networks:
  mastodon-network:
    driver: bridge
  dokploy-network:
    external: true
