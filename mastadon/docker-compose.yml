services:
  mastodon-db:
    image: postgres:14
    container_name: mastodon-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-mastodon}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-mastodon}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - mastodon-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mastodon}"]
      interval: 10s
      timeout: 5s
      retries: 5

  mastodon-redis:
    image: redis:7-alpine
    container_name: mastodon-redis
    command: redis-server --appendonly yes
    volumes:
      - ./data/redis:/data
    networks:
      - mastodon-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mastodon-web:
    image: lscr.io/linuxserver/mastodon:4.2.0
    container_name: mastodon-web
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      LOCAL_DOMAIN: ${LOCAL_DOMAIN:-twist3dkinkst3r.com}
      WEB_DOMAIN: ${WEB_DOMAIN:-twist3dkinkst3r.com}
      REDIS_HOST: mastodon-redis
      REDIS_PORT: 6379
      DB_HOST: mastodon-db
      DB_USER: ${POSTGRES_USER:-mastodon}
      DB_NAME: ${POSTGRES_DB:-mastodon}
      DB_PASS: ${POSTGRES_PASSWORD}
      DB_PORT: 5432
      ES_ENABLED: ${ES_ENABLED:-false}
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY:-}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY:-}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT:-}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-}
      OTP_SECRET: ${OTP_SECRET:-}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY:-}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
      SMTP_SERVER: ${SMTP_SERVER:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_LOGIN: ${SMTP_LOGIN:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_ADDRESS: ${SMTP_FROM_ADDRESS:-noreply@twist3dkinkst3r.com}
      SMTP_TLS: ${SMTP_TLS:-true}
      S3_ENABLED: ${S3_ENABLED:-true}
      S3_BUCKET: ${S3_BUCKET:-twist3dkinkst3r-mastodon}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-auto}
      S3_ALIAS_HOST: ${S3_ALIAS_HOST:-files.twist3dkinkst3r.com}
      SIDEKIQ_ONLY: false
      SIDEKIQ_THREADS: ${SIDEKIQ_THREADS:-5}
      DB_POOL: ${DB_POOL:-5}
      MASTODON_PROMETHEUS_EXPORTER_ENABLED: ${MASTODON_PROMETHEUS_EXPORTER_ENABLED:-false}
    volumes:
      - ./data/config:/config
    networks:
      - mastodon-network
      - traefik-network
    depends_on:
      mastodon-db:
        condition: service_healthy
      mastodon-redis:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mastodon.rule=Host(`twist3dkinkst3r.com`)"
      - "traefik.http.routers.mastodon.entrypoints=websecure"
      - "traefik.http.routers.mastodon.tls.certresolver=letsencrypt"
      - "traefik.http.routers.mastodon.middlewares=security-headers@file"
      - "traefik.http.services.mastodon.loadbalancer.server.port=3000"

  mastodon-sidekiq:
    image: lscr.io/linuxserver/mastodon:4.2.0
    container_name: mastodon-sidekiq
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[s]idekiq' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      PUID: ${PUID:-1000}
      PGID: ${PGID:-1000}
      TZ: ${TZ:-America/New_York}
      LOCAL_DOMAIN: ${LOCAL_DOMAIN:-twist3dkinkst3r.com}
      REDIS_HOST: mastodon-redis
      REDIS_PORT: 6379
      DB_HOST: mastodon-db
      DB_USER: ${POSTGRES_USER:-mastodon}
      DB_NAME: ${POSTGRES_DB:-mastodon}
      DB_PASS: ${POSTGRES_PASSWORD}
      DB_PORT: 5432
      ES_ENABLED: ${ES_ENABLED:-false}
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY:-}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY:-}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT:-}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-}
      OTP_SECRET: ${OTP_SECRET:-}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY:-}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
      SIDEKIQ_ONLY: true
      SIDEKIQ_THREADS: ${SIDEKIQ_THREADS:-5}
      DB_POOL: ${DB_POOL:-5}
    volumes:
      - ./data/config:/config
    networks:
      - mastodon-network
    depends_on:
      mastodon-db:
        condition: service_healthy
      mastodon-redis:
        condition: service_healthy
    restart: unless-stopped

networks:
  mastodon-network:
    driver: bridge
  traefik-network:
    external: true
    name: traefik-network

