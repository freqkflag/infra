services:
  backup:
    image: alpine:3.19
    container_name: backup
    restart: "no"  # Manual or cron-triggered
    volumes:
      - ./scripts:/scripts:ro
      - ./config:/config:ro
      - ./data:/backups
      - /root/infra:/infra:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backup-network
      - traefik-network
    environment:
      - TZ=${TZ:-America/New_York}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
      - BACKUP_RETENTION_WEEKS=${BACKUP_RETENTION_WEEKS:-12}
    command: /scripts/backup-all.sh
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true

networks:
  backup-network:
    driver: bridge
  traefik-network:
    external: true
    name: traefik-network

